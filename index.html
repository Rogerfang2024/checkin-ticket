<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>入場核銷</title>

  <style>
    :root{
      --bg:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --card:#ffffff;
      --border:#e5e7eb;
      --shadow:0 10px 28px rgba(17,24,39,.10);

      --primary:#1d4ed8;
      --primaryText:#ffffff;

      --okBg:#ecfdf5;   --okBd:#a7f3d0;   --okTx:#065f46;
      --warnBg:#fffbeb; --warnBd:#fcd34d; --warnTx:#92400e;
      --badBg:#fef2f2;  --badBd:#fecaca;  --badTx:#991b1b;
    }

    html, body{
      width:100%;
      max-width:100%;
      margin:0;
      padding:0;
      overflow-x:hidden;
      background:var(--bg);
      color:var(--text);
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
      font-family: system-ui, -apple-system, "Noto Sans TC", "Microsoft JhengHei", sans-serif;
    }

    .page{
      width:100vw;
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      box-sizing:border-box;
      padding: 16px;
      padding-top: calc(28px + env(safe-area-inset-top));
      padding-bottom: calc(16px + env(safe-area-inset-bottom));
      background: var(--bg);
    }

    .container{ width:100%; max-width: 460px; }
    .small{ color:var(--muted); font-size: 13px; margin: 0 0 10px; }

    .card{
      width:100%;
      background:var(--card);
      border:1px solid rgba(229,231,235,.95);
      border-radius: 20px;
      padding: 22px;
      box-shadow: var(--shadow);
      box-sizing:border-box;
    }

    .title{
      font-size: 22px;
      font-weight: 900;
      margin: 6px 0 14px;
      letter-spacing: .2px;
      line-height: 1.2;
    }

    .field{ margin: 14px 0; }

    label{
      display:block;
      font-size: 14px;
      margin-bottom: 8px;
      color: var(--muted);
      font-weight: 700;
    }

    input, select{
      width: 100%;
      font-size: 18px;
      padding: 14px 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: #ffffff;
      color: var(--text);
      outline:none;
      box-sizing: border-box;
    }

    input::placeholder{ color:#9ca3af; }
    input:focus, select:focus{
      border-color: rgba(29,78,216,.55);
      box-shadow: 0 0 0 4px rgba(29,78,216,.12);
    }

    button{
      width: 100%;
      font-size: 20px;
      font-weight: 900;
      padding: 14px 12px;
      border-radius: 16px;
      border: 0;
      background: var(--primary);
      color: var(--primaryText);
      cursor:pointer;
      box-sizing:border-box;
      box-shadow: 0 10px 18px rgba(29,78,216,.18);
      transition: transform .06s ease, box-shadow .12s ease, opacity .12s ease;
    }
    button:active{ transform: translateY(1px); box-shadow: 0 6px 12px rgba(29,78,216,.16); }
    button:disabled{ opacity:.55; cursor:not-allowed; box-shadow:none; }

    .btnSecondary{
      background:#ffffff;
      color:var(--text);
      border:1px solid var(--border);
      box-shadow:none;
    }

    .center{ text-align:center; }

    .rule{
      margin-top: 12px;
      font-size: 13px;
      line-height: 1.5;
      color: var(--warnTx);
      background: var(--warnBg);
      border: 1px solid var(--warnBd);
      border-radius: 14px;
      padding: 10px 12px;
    }

    .hint{
      margin: 10px 0 0;
      font-size: 14px;
      font-weight: 800;
      border-radius: 14px;
      padding: 10px 12px;
      border: 1px solid var(--border);
      background: #f3f4f6;
      color: var(--text);
    }
    .hintBad{ background: var(--badBg); border-color: var(--badBd); color: var(--badTx); }
    .hintWarn{ background: var(--warnBg); border-color: var(--warnBd); color: var(--warnTx); }
    .hidden{ display:none !important; }

    .resultIcon{ font-size: 48px; margin: 6px 0 2px; }
    .resultTitle{ font-size: 30px; font-weight: 1000; margin: 4px 0 6px; }
    .resultCount{ font-size: 44px; font-weight: 1000; margin: 8px 0 12px; letter-spacing:.2px; }

    .pill{
      display:inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      background: #f3f4f6;
      border:1px solid var(--border);
      font-weight: 800;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }

    .row{
      display:flex;
      justify-content:space-between;
      gap: 12px;
      margin-top: 10px;
      font-size: 16px;
      align-items: center;
    }

    .muted{ color:var(--muted); }
    .ok{ background:var(--okBg); border-color: var(--okBd); }
    .warn{ background:var(--warnBg); border-color: var(--warnBd); }
    .bad{ background:var(--badBg); border-color: var(--badBd); }
    .okText{ color:var(--okTx); }
    .warnText{ color:var(--warnTx); }
    .badText{ color:var(--badTx); }
  </style>
</head>

<body>
  <div class="page">
    <div class="container">
      <div class="small">《國有器官》台南放映｜入場核銷</div>

      <div id="viewForm" class="card">
        <div class="title">請輸入手機完成入場</div>

        <div class="field">
          <label>手機號碼（09 開頭）</label>
          <input id="phone" inputmode="numeric" placeholder="例如：0912345678 或 912345678" />
        </div>

        <div id="hint" class="hint hidden"></div>

        <div class="field">
          <label>本次入場人數</label>
          <select id="count" disabled>
            <option value="">請先輸入手機</option>
          </select>
        </div>

        <button id="btnCheck" onclick="checkIn()" disabled>確認入場</button>

        <div class="rule">
          ⚠️ 本次入場人數＝「現在站在入口的人數」<br/>
          按下後請勿重複操作，請等結果畫面
        </div>
      </div>

      <div id="viewLoading" class="card center hidden">
        <div class="resultIcon">⏳</div>
        <div class="resultTitle">正在核銷…</div>
        <div class="muted">請勿重複按，約 1–3 秒顯示結果</div>
      </div>

      <div id="viewResult" class="card hidden"></div>

      <!-- 非成功狀態才顯示（服務台用） -->
      <div id="viewActions" class="grid hidden">
        <button onclick="backToForm()">返回重核銷</button>
        <button class="btnSecondary" onclick="resetAll()">清除重填</button>
      </div>
    </div>
  </div>

  <script>
    const elPhone = document.getElementById('phone');
    const elCount = document.getElementById('count');
    const elBtn   = document.getElementById('btnCheck');
    const elHint  = document.getElementById('hint');

    const viewForm    = document.getElementById('viewForm');
    const viewLoading = document.getElementById('viewLoading');
    const viewResult  = document.getElementById('viewResult');
    const viewActions = document.getElementById('viewActions');

    let lastLookup = null;
    let lookupTimer = null;

    function show(view) {
      viewForm.classList.add('hidden');
      viewLoading.classList.add('hidden');
      viewResult.classList.add('hidden');
      view.classList.remove('hidden');
    }

    function showHint(msg, type) {
      if (!msg) { elHint.classList.add('hidden'); return; }
      elHint.textContent = msg;
      elHint.classList.remove('hidden');
      elHint.classList.remove('hintBad','hintWarn');
      if (type === 'bad') elHint.classList.add('hintBad');
      else if (type === 'warn') elHint.classList.add('hintWarn');
    }

    function hideActions_(){
      viewActions.classList.add('hidden');
      viewActions.style.display = 'none';
    }
    function showActions_(){
      viewActions.classList.remove('hidden');
      viewActions.style.display = 'grid';
    }

    function resetAll() {
      elPhone.value = '';
      showHint('', '');
      elCount.innerHTML = `<option value="">請先輸入手機</option>`;
      elCount.disabled = true;
      elBtn.disabled = true;
      lastLookup = null;
      hideActions_();
      show(viewForm);
    }

    function backToForm() {
      hideActions_();
      show(viewForm);
    }

    function endAndExit(){
      try { window.close(); } catch(e) {}
      document.body.innerHTML = `
        <div style="font-family:system-ui,-apple-system,'Noto Sans TC','Microsoft JhengHei',sans-serif;
                    padding:24px; text-align:center;">
          <div style="font-size:22px; font-weight:900; margin-top:18px;">已完成入場核銷</div>
          <div style="margin-top:10px; color:#6b7280; font-size:14px; line-height:1.6;">
            請直接關閉此頁面（或返回上一頁）
          </div>
        </div>
      `;
    }

    function digitsOnly(s){ return String(s||'').replace(/\D/g,''); }

    // 只在「完整格式」才查（避免輸入中誤導）
    function isReadyToLookup(d){
      if (/^9\d{8}$/.test(d)) return true;        // 9碼：9xxxxxxxx
      if (/^09\d{8}$/.test(d)) return true;       // 10碼：09xxxxxxxx
      if (/^8869\d{8}$/.test(d)) return true;     // 8869xxxxxxxx
      if (/^88609\d{8}$/.test(d)) return true;    // 88609xxxxxxxx（保險）
      return false;
    }

    function setCountOptions(remaining) {
      const max = Math.max(0, remaining || 0);
      if (max <= 0) {
        elCount.innerHTML = `<option value="">名額已用完</option>`;
        elCount.disabled = true;
        elBtn.disabled = true;
        return;
      }
      let html = `<option value="">請選擇人數</option>`;
      for (let i = 1; i <= max; i++) html += `<option value="${i}">${i}</option>`;
      elCount.innerHTML = html;
      elCount.disabled = false;
      elBtn.disabled = true;
    }

    elCount.addEventListener('change', () => {
      elBtn.disabled = !(lastLookup && lastLookup.ok && elCount.value);
    });

    // debounce：停 300ms 才查
    elPhone.addEventListener('input', () => {
      const d = digitsOnly(elPhone.value.trim());

      lastLookup = null;
      elBtn.disabled = true;
      elCount.disabled = true;
      elCount.innerHTML = `<option value="">請先輸入手機</option>`;

      // 輸入中不顯示任何「手機不正確」
      showHint('', '');

      if (!isReadyToLookup(d)) return;

      showHint('查詢中…', 'warn');
      if (lookupTimer) clearTimeout(lookupTimer);
      lookupTimer = setTimeout(() => lookup(), 300);
    });

    async function postJSON(url, data){
      const r = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data),
      });
      return await r.json();
    }

    async function lookup() {
      try{
        const res = await postJSON("/.netlify/functions/lookup", { phone: elPhone.value });
        lastLookup = res;

        if (!res || !res.ok) {
          const status = res && res.status ? res.status : 'error';

          if (status === 'not_found') {
            showHint('查無此人，請跟服務台聯絡', 'bad');
            elCount.innerHTML = `<option value="">查無此人</option>`;
          } else {
            showHint('系統忙碌，請稍後再試', 'warn');
            elCount.innerHTML = `<option value="">系統忙碌</option>`;
          }

          elCount.disabled = true;
          elBtn.disabled = true;
          return;
        }

        showHint('', '');
        setCountOptions(res.remaining);
      }catch(e){
        showHint('系統忙碌，請稍後再試', 'warn');
        elCount.innerHTML = `<option value="">系統忙碌</option>`;
        elCount.disabled = true;
        elBtn.disabled = true;
      }
    }

    async function checkIn() {
      const phone = elPhone.value.trim();
      const count = elCount.value;

      if (!count) {
        alert('請選擇本次入場人數');
        return;
      }

      elBtn.disabled = true;
      hideActions_();
      show(viewLoading);

      try{
        const res = await postJSON("/.netlify/functions/checkin", { phone, count });
        renderResult(res);
      }catch(e){
        renderResult({ ok:false, status:'error', message:'系統忙碌或發生錯誤，請再試一次。' });
      }
    }

    function renderResult(res) {
      viewResult.className = 'card';

      // 最關鍵：先把底部按鈕徹底隱藏（避免殘留）
      hideActions_();

      if (res && res.ok && res.status === 'success') {
        viewResult.classList.add('ok');
        viewResult.innerHTML = `
          <div class="small">《國有器官》台南放映｜入場核銷</div>

          <div class="center okText">
            <div class="resultIcon">✅</div>
            <div class="resultTitle">已放行</div>
            <div class="resultCount">本次入場：${res.countThisTime} 人</div>
          </div>

          <div class="row"><div class="muted">入場碼</div><div class="pill">${escapeHtml(res.code || '—')}</div></div>
          <div class="row"><div class="muted">手機末 3 碼</div><div><b>${escapeHtml(res.suffix || '—')}</b></div></div>
          <div class="row"><div class="muted">姓名</div><div><b>${escapeHtml(res.nameMasked || '—')}</b></div></div>

          <div class="row"><div class="muted">報名 / 已入場 / 剩餘</div>
            <div><b>${res.qty} / ${res.used} / ${res.remaining}</b></div>
          </div>

          <div class="row"><div class="muted">核銷時間</div><div><b>${escapeHtml(res.timeText || '')}</b></div></div>

          <div class="rule">請出示此畫面入場</div>

          <div style="margin-top:12px;">
            <button onclick="endAndExit()">結束離開</button>
          </div>
        `;
        show(viewResult);
        return;
      }

      // 非成功：顯示服務台用按鈕
      showActions_();

      const status = (res && res.status) || 'error';
      const msg = (res && res.message) || '系統忙碌，請再試一次。';

      if (status === 'insufficient') viewResult.classList.add('warn');
      else viewResult.classList.add('bad');

      const icon = (status === 'insufficient') ? '⚠️' : '⛔';
      const textClass = (status === 'insufficient') ? 'warnText' : 'badText';

      viewResult.innerHTML = `
        <div class="small">《國有器官》台南放映｜入場核銷</div>

        <div class="center ${textClass}">
          <div class="resultIcon">${icon}</div>
          <div class="resultTitle">${escapeHtml(msg)}</div>
        </div>

        ${res && res.maskedPhone ? `<div class="row"><div class="muted">你輸入</div><div><b>${escapeHtml(res.maskedPhone)}</b></div></div>` : ''}
        ${res && typeof res.qty !== 'undefined' ? `<div class="row"><div class="muted">報名 / 已入場 / 剩餘</div><div><b>${res.qty} / ${res.used} / ${res.remaining}</b></div></div>` : ''}

        <div class="rule">請跟服務台聯絡</div>
      `;
      show(viewResult);
    }

    function escapeHtml(s) {
      return String(s ?? '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    // 頁面進來先把 actions 隱藏
    hideActions_();
  </script>
</body>
</html>
